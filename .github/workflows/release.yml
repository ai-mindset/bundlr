name: Build and Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

jobs:
  build:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-linux
            artifact_name: bundlr-linux-x86_64
          - os: macos-latest
            target: x86_64-macos
            artifact_name: bundlr-macos-x86_64
          - os: macos-latest
            target: aarch64-macos
            artifact_name: bundlr-macos-aarch64
          - os: windows-latest
            target: x86_64-windows
            artifact_name: bundlr-windows-x86_64.exe

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup Zig
        uses: mlugg/setup-zig@v2
        with:
          version: 0.15.2

      - name: Build bundlr
        run: zig build -Doptimize=ReleaseFast -Dtarget=${{ matrix.target }}
        env:
          # Ensure environment variables that affect the build are not set
          # to maintain reproducibility. These optional env vars can embed
          # values into the binary, so we explicitly unset them.
          BUNDLR_PROJECT_NAME: ""
          BUNDLR_PROJECT_VERSION: ""
          BUNDLR_PYTHON_VERSION: ""

      - name: Rename artifact (Unix)
        if: runner.os != 'Windows'
        run: |
          cp zig-out/bin/bundlr ${{ matrix.artifact_name }}

      - name: Rename artifact (Windows)
        if: runner.os == 'Windows'
        shell: cmd
        run: copy zig-out\bin\bundlr.exe ${{ matrix.artifact_name }}

      - name: Generate checksum
        shell: bash
        run: |
          if [ "${{ runner.os }}" = "Windows" ]; then
            # Use PowerShell for reliable checksum on Windows
            powershell -Command "(Get-FileHash -Algorithm SHA256 '${{ matrix.artifact_name }}').Hash.ToLower()" > "${{ matrix.artifact_name }}.sha256"
          else
            shasum -a 256 "${{ matrix.artifact_name }}" | awk '{print $1}' > "${{ matrix.artifact_name }}.sha256"
          fi
          echo "Checksum for ${{ matrix.artifact_name }}:"
          cat "${{ matrix.artifact_name }}.sha256"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            ${{ matrix.artifact_name }}
            ${{ matrix.artifact_name }}.sha256

  release:
    name: Create Release
    needs: build
    runs-on: ubuntu-latest
    permissions:
      contents: write
      attestations: write
      id-token: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Display structure of downloaded files
        run: ls -R artifacts

      - name: Flatten artifacts directory
        run: |
          mkdir -p release-files
          find artifacts -type f -exec cp {} release-files/ \;
          ls -lh release-files/

      - name: Generate combined SHA256SUMS file
        run: |
          cd release-files
          # Generate checksums for all binaries
          shopt -s nullglob
          for file in bundlr-*; do
            if [[ ! "$file" == *.sha256 ]]; then
              shasum -a 256 "$file" >> SHA256SUMS
            fi
          done
          if [ ! -f SHA256SUMS ]; then
            echo "Error: No binaries found to checksum"
            exit 1
          fi
          echo "Generated SHA256SUMS:"
          cat SHA256SUMS

      - name: Attest build provenance
        uses: actions/attest-build-provenance@v2
        with:
          subject-path: |
            release-files/bundlr-linux-x86_64
            release-files/bundlr-macos-x86_64
            release-files/bundlr-macos-aarch64
            release-files/bundlr-windows-x86_64.exe

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            release-files/bundlr-linux-x86_64
            release-files/bundlr-linux-x86_64.sha256
            release-files/bundlr-macos-x86_64
            release-files/bundlr-macos-x86_64.sha256
            release-files/bundlr-macos-aarch64
            release-files/bundlr-macos-aarch64.sha256
            release-files/bundlr-windows-x86_64.exe
            release-files/bundlr-windows-x86_64.exe.sha256
            release-files/SHA256SUMS
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## üîí Verifying Downloads

            All binaries include SHA256 checksums for verification. Download both the binary and its `.sha256` file to verify:

            **Linux/macOS:**
            ```bash
            # Download binary and checksum
            curl -LO https://github.com/ai-mindset/bundlr/releases/download/${{ github.ref_name }}/bundlr-linux-x86_64
            curl -LO https://github.com/ai-mindset/bundlr/releases/download/${{ github.ref_name }}/bundlr-linux-x86_64.sha256

            # Verify checksum
            echo "$(cat bundlr-linux-x86_64.sha256)  bundlr-linux-x86_64" | shasum -a 256 -c -
            ```

            **Windows (PowerShell):**
            ```powershell
            # Download binary and checksum
            Invoke-WebRequest -Uri "https://github.com/ai-mindset/bundlr/releases/download/${{ github.ref_name }}/bundlr-windows-x86_64.exe" -OutFile "bundlr-windows-x86_64.exe"
            Invoke-WebRequest -Uri "https://github.com/ai-mindset/bundlr/releases/download/${{ github.ref_name }}/bundlr-windows-x86_64.exe.sha256" -OutFile "bundlr-windows-x86_64.exe.sha256"

            # Verify checksum
            $expected = Get-Content bundlr-windows-x86_64.exe.sha256
            $actual = (Get-FileHash bundlr-windows-x86_64.exe -Algorithm SHA256).Hash.ToLower()
            if ($expected -eq $actual) { Write-Host "‚úì Checksum verified!" -ForegroundColor Green } else { Write-Host "‚úó Checksum mismatch!" -ForegroundColor Red }
            ```

            You can also verify the complete `SHA256SUMS` file for all binaries.

            ### üõ°Ô∏è Build Provenance

            This release includes [SLSA build provenance attestations](https://slsa.dev/) generated by GitHub Actions. You can verify the authenticity and build process using the GitHub CLI:

            ```bash
            # Install GitHub CLI if needed: https://cli.github.com/
            gh attestation verify bundlr-linux-x86_64 --repo ai-mindset/bundlr
            ```

            This ensures the binaries were built by our official CI pipeline and haven't been tampered with.
